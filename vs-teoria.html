<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Clube Morpheus - Gráfico de Performance</title>
  <link rel="icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background-color: #fff;
      font-family: "DM Sans", sans-serif;
      color: #000;
      height: 100%;
    }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.9);
      padding: 10px 20px;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      z-index: 10;
      color: white;
      box-sizing: border-box;
    }

    .navbar .welcome {
      font-weight: bold;
      font-size: 16px;
    }

    .navbar .links {
      display: flex;
      gap: 20px;
    }

    .navbar a {
      color: white;
      text-decoration: none;
      font-weight: bold;
      font-size: 16px;
      transition: transform 0.2s ease-in-out;
    }

    .navbar a:hover {
      transform: scale(1.1);
    }

    .container {
      margin-top: 60px;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 20px 0;
      min-height: calc(100vh - 80px);
    }

    .header-info {
      width: 95%;
      max-width: 1200px;
      text-align: left;
      margin-bottom: 20px;
    }

    .header-info h1 {
      font-size: 22px;
      color: #1E4DB7;
      margin: 0 0 2px 0;
      text-align: left;
    }

    .cnpj {
      font-size: 13px;
      color: #555;
      margin: 0 0 2px 0;
      text-align: left;
    }

    .subtitle {
      font-size: 13px;
      color: #555;
      margin: 0;
      text-align: left;
    }

    /* Container principal do gráfico único */
    .main-chart-single-container {
      width: 95%;
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    /* Container do gráfico único */
    .chart-container-single {
      width: 100%;
      height: 450px;
      background-color: #fff;
      border-radius: 8px;
      padding: 20px;
      box-sizing: border-box;
      position: relative;
    }

    .chart-container-single canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* Ajustes para mobile vertical */
    .mobile-device .chart-container-single {
      height: 400px;
      padding: 15px;
    }

    /* Ajustes para mobile landscape */
    .mobile-landscape .chart-container-single {
      height: 350px;
      padding: 15px;
    }

    /* NAVBAR E FONTES AUMENTADAS NO MOBILE VERTICAL */
    .mobile-device .navbar {
      padding: 18px 20px;
      min-height: 75px;
    }

    .mobile-device .navbar .welcome {
      font-size: 24px;
      font-weight: bold;
    }

    .mobile-device .navbar .links {
      gap: 20px;
    }

    .mobile-device .navbar a {
      font-size: 24px;
      font-weight: bold;
    }

    .loading {
      color: #666;
      font-style: italic;
    }

    .error {
      color: #ff0000;
      background-color: #ffe6e6;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }

    #deviceInfo {
      display: none !important;
    }

    /* ESTILOS DO TOOLTIP PERSONALIZADO */
    .custom-tooltip {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #164CAD;
      border-radius: 8px;
      padding: 12px 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      pointer-events: none;
      z-index: 100;
      font-family: "Montserrat", sans-serif;
      backdrop-filter: blur(5px);
      transition: opacity 0.2s ease;
      opacity: 0;
    }

    .custom-tooltip.visible {
      opacity: 1;
    }

    .custom-tooltip::before {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      border-style: solid;
    }

    .custom-tooltip.top::before {
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 8px 8px 0 8px;
      border-color: #164CAD transparent transparent transparent;
    }

    .custom-tooltip.bottom::before {
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 0 8px 8px 8px;
      border-color: transparent transparent #164CAD transparent;
    }

    .custom-tooltip.left::before {
      right: -8px;
      top: 50%;
      transform: translateY(-50%);
      border-width: 8px 0 8px 8px;
      border-color: transparent transparent transparent #164CAD;
    }

    .custom-tooltip.right::before {
      left: -8px;
      top: 50%;
      transform: translateY(-50%);
      border-width: 8px 8px 8px 0;
      border-color: transparent #164CAD transparent transparent;
    }

    .tooltip-header {
      font-weight: 550;
      color: #000;
      margin-bottom: 8px;
      font-size: 14px;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 4px;
    }

    .tooltip-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .tooltip-item:last-child {
      margin-bottom: 0;
    }

    .tooltip-label {
      display: flex;
      align-items: center;
      color: #000;
    }

    .tooltip-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      display: inline-block;
    }

    .tooltip-value {
      font-weight: 400;
      color: #000;
      margin-left: 12px;
    }

    /* Legenda compartilhada */
    .shared-legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 10px 0 15px 0;
      padding: 8px 15px;
      background-color: #f8f9fa;
      border-radius: 6px;
      flex-wrap: wrap;
      width: 100%;
      max-width: 1200px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 13px;
      color: #333;
      transition: opacity 0.2s;
    }

    .legend-item:hover {
      opacity: 0.8;
    }

    .legend-item.hidden {
      opacity: 0.3;
      text-decoration: line-through;
    }

    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
    }

    /* Estilo para o eixo Y deslocado */
    .second-y-axis {
      position: relative;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="welcome" id="welcomeUser">Bem-vindo(a)</div>
    <div class="links">
      <a href="dashboard.html">Dashboard</a>
      <a href="lamina.html">Lâmina</a>
      <a href="minha-area.html">Minha Área</a>
    </div>
  </div>

  <div class="container">
    <div class="header-info">
      <h1>Morpheus Clube de Investimentos</h1>
      <div class="cnpj">61.043.820/0001-55</div>
      <div class="subtitle" id="subtitle">Carregando dados...</div>
    </div>
    
    <div class="main-chart-single-container">
      <!-- Legenda compartilhada -->
      <div class="shared-legend" id="sharedLegend"></div>
      
      <!-- Container único do gráfico -->
      <div class="chart-container-single">
        <canvas id="performanceChart"></canvas>
      </div>
    </div>

    <div id="deviceInfo"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAYLyEfTVl8zR1drcNYi7K33IT6ytVJYJ8",
      authDomain: "login-site-9cbbd.firebaseapp.com",
      projectId: "login-site-9cbbd",
      storageBucket: "login-site-9cbbd.appspot.com",
      messagingSenderId: "703993528666",
      appId: "1:703993528666:web:1e7a02cb5b611e24c97363",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const docRef = doc(db, "usuarios", user.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          const nome = data.nome || "Usuário";
          const genero = (data.genero || "masculino").toLowerCase();
          const saudacao = genero === "feminino" ? "Bem-vinda" : "Bem-vindo";
          document.getElementById("welcomeUser").textContent = `${saudacao}, ${nome}`;
        }
      } else {
        window.location.href = "index.html";
      }
    });

    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0orwAIfSmQxmbGdGCvjj3CZNbRnqo3Fr0ujodTX3JIcptCrR_ElNMZZn8tJ7MVg1W7Zeu5-KvLQLM/pub?gid=0&single=true&output=csv";

    // Variável global para armazenar a instância do gráfico
    window.chartInstance = null;

    // Tooltip personalizado
    let customTooltip = null;

    function createCustomTooltip() {
      if (customTooltip) return customTooltip;
      
      customTooltip = document.createElement('div');
      customTooltip.className = 'custom-tooltip';
      document.querySelector('.main-chart-single-container').appendChild(customTooltip);
      return customTooltip;
    }

    function showCustomTooltip(chart, tooltip) {
      const tooltipEl = createCustomTooltip();
      
      if (tooltip.opacity === 0) {
        tooltipEl.classList.remove('visible');
        return;
      }

      if (tooltip.body) {
        const title = tooltip.title[0] || '';
        let tooltipHTML = `<div class="tooltip-header">${title}</div>`;
        
        tooltip.dataPoints.forEach((dataPoint, index) => {
          const dataset = chart.data.datasets[dataPoint.datasetIndex];
          const label = dataset.label || '';
          const color = dataset.borderColor || dataset.backgroundColor || '#164CAD';
          let value = '';
          
          if (label === "Dados AO") {
            value = dataPoint.raw.y.toFixed(1).replace('.', ',') + '%';
          } else {
            value = dataPoint.raw.y.toFixed(2).replace('.', ',') + '%';
          }
          
          tooltipHTML += `
            <div class="tooltip-item">
              <span class="tooltip-label">
                <span class="tooltip-color" style="background-color: ${color}"></span>
                ${label}
              </span>
              <span class="tooltip-value">${value}</span>
            </div>
          `;
        });
        
        tooltipEl.innerHTML = tooltipHTML;
      }

      const position = chart.canvas.getBoundingClientRect();
      const chartContainer = document.querySelector('.main-chart-single-container');
      const containerRect = chartContainer.getBoundingClientRect();
      
      let left = position.left + tooltip.caretX - containerRect.left;
      let top = position.top + tooltip.caretY - containerRect.top;
      
      const tooltipWidth = tooltipEl.offsetWidth;
      const tooltipHeight = tooltipEl.offsetHeight;
      
      let placement = 'top';
      
      if (top - tooltipHeight - 10 < 0) {
        placement = 'bottom';
        top += 20;
      } else {
        top -= tooltipHeight + 10;
      }
      
      if (left + tooltipWidth > containerRect.width) {
        left = containerRect.width - tooltipWidth - 10;
      } else if (left < 0) {
        left = 10;
      } else {
        left -= tooltipWidth / 2;
      }
      
      tooltipEl.style.left = left + 'px';
      tooltipEl.style.top = top + 'px';
      
      tooltipEl.className = `custom-tooltip ${placement} visible`;
    }

    // Função para criar legenda compartilhada
    function createSharedLegend(datasets) {
      const legendContainer = document.getElementById('sharedLegend');
      legendContainer.innerHTML = '';
      
      datasets.forEach((dataset, index) => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.dataset.index = index;
        
        legendItem.innerHTML = `
          <div class="legend-color" style="background-color: ${dataset.borderColor || dataset.backgroundColor}"></div>
          <span>${dataset.label}</span>
        `;
        
        // Adiciona evento de clique para mostrar/esconder dataset
        legendItem.addEventListener('click', () => {
          const chart = window.chartInstance;
          const meta = chart.getDatasetMeta(index);
          
          // Alterna visibilidade
          meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
          chart.update();
          
          // Atualiza aparência da legenda
          legendItem.classList.toggle('hidden', meta.hidden);
        });
        
        legendContainer.appendChild(legendItem);
      });
    }

    async function loadData() {
      try {
        console.log("Iniciando carregamento de dados...");
        
        const response = await fetch(csvUrl);
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const data = await response.text();
        console.log("Dados CSV carregados:", data.substring(0, 200));
        
        const rows = data.split("\n").filter(row => row.trim() !== '');
        console.log("Número de linhas:", rows.length);

        if (rows.length < 2) {
          throw new Error("Dados insuficientes no CSV");
        }

        const allDates = [];
        const morpheus = [];
        const teoria = [];
        const dadosAO = [];

        for (let i = 1; i < rows.length; i++) {
          const cols = rows[i].split(",");
          if (cols.length >= 43) {
            const date = cols[39]?.trim();
            const morpheusVal = parseFloat(cols[41]);
            const teoriaVal = parseFloat(cols[42]);
            const aoVal = parseFloat(cols[40]);
            
            if (date && !isNaN(morpheusVal) && !isNaN(teoriaVal)) {
              allDates.push(date);
              morpheus.push((morpheusVal - 1) * 100);
              teoria.push((teoriaVal - 1) * 100);
              dadosAO.push(!isNaN(aoVal) ? (aoVal * 100) : 0);
            }
          }
        }

        console.log("Dados processados:", allDates.length, "datapoints");

        if (allDates.length === 0) {
          throw new Error("Nenhum dado válido encontrado");
        }

        const lastDate = allDates[allDates.length - 1];
        document.getElementById("subtitle").textContent = `Última atualização: ${lastDate}`;

        createChart(allDates, morpheus, teoria, dadosAO);

      } catch (error) {
        console.error("Erro ao carregar dados:", error);
        document.getElementById("subtitle").textContent = "Erro ao carregar dados: " + error.message;
      }
    }

    function createChart(allDates, morpheus, teoria, dadosAO) {
      // Preparar dados
      const morpheusData = allDates.map((date, i) => ({
        x: date.split("/").reverse().join("-"),
        y: morpheus[i]
      }));

      const teoriaData = allDates.map((date, i) => ({
        x: date.split("/").reverse().join("-"),
        y: teoria[i]
      }));

      const aoData = allDates.map((date, i) => ({
        x: date.split("/").reverse().join("-"),
        y: dadosAO[i]
      }));

      // Configuração comum para os eixos X
      const commonXOptions = {
        type: "time",
        time: {
          unit: "month",
          displayFormats: { 
            month: "MMM - yy" 
          },
          tooltipFormat: "dd/MM/yyyy"
        },
        grid: { 
          color: "rgba(0,0,0,0.05)",
          drawBorder: false
        },
        ticks: {
          color: "#000000",
          maxRotation: 45,
          minRotation: 45,
          font: {
            family: "Montserrat",
            size: 12,
            weight: "300",
          },
          callback: function(value, index, values) {
            const date = new Date(value);
            const month = date.getMonth();
            const year = date.getFullYear().toString().slice(-2);
            
            const mesesPortugues = [
              'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
              'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'
            ];
            
            return `${mesesPortugues[month]} - ${year}`;
          }
        }
      };

      const isMobileVertical = document.body.classList.contains('mobile-device') && 
                          !document.body.classList.contains('mobile-landscape');
      
      const axisFontSize = isMobileVertical ? 18 : 12;

      // Destruir gráfico anterior se existir
      if (window.chartInstance) window.chartInstance.destroy();

      // Criar gradiente para Morpheus
      const createGradient = (ctx, chartArea, color1, color2, color3) => {
        const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
        gradient.addColorStop(0, color1);
        gradient.addColorStop(0.5, color2);
        gradient.addColorStop(1, color3);
        return gradient;
      };

      // Configuração do gráfico único com dois eixos à esquerda
      const ctx = document.getElementById('performanceChart').getContext('2d');
      
      // Calcular limites dos eixos Y
      const morpheusTeoriaData = [...morpheus, ...teoria];
      const morpheusTeoriaMin = Math.min(...morpheusTeoriaData);
      const morpheusTeoriaMax = Math.max(...morpheusTeoriaData);
      
      const aoMin = Math.min(...dadosAO);
      const aoMax = Math.max(...dadosAO);
      
      // Configurar step size apropriado
      const morpheusStep = 5;
      const aoStep = 0.5;
      
      const morpheusYMin = Math.floor(morpheusTeoriaMin / morpheusStep) * morpheusStep;
      const morpheusYMax = Math.ceil(morpheusTeoriaMax / morpheusStep) * morpheusStep;
      
      const aoYMin = Math.floor(aoMin / aoStep) * aoStep;
      const aoYMax = Math.ceil(aoMax / aoStep) * aoStep;

      window.chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          datasets: [
            {
              label: "Morpheus",
              data: morpheusData,
              borderColor: "#164CAD",
              borderWidth: 3,
              pointRadius: 0,
              tension: 0.15,
              fill: false,
              yAxisID: 'y-left-primary',
              order: 2,
            },
            {
              label: "Teoria",
              data: teoriaData,
              borderColor: "#000000",
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.15,
              borderDash: [5, 5],
              fill: false,
              yAxisID: 'y-left-primary',
              order: 1,
            },
            {
              label: "Dados AO",
              data: aoData,
              borderColor: "#4D7FDB",
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.15,
              fill: {
                target: 'origin',
                above: 'rgba(77, 127, 219, 0.2)',
                below: 'rgba(77, 127, 219, 0.05)'
              },
              yAxisID: 'y-left-secondary',
              order: 3,
            }
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index',
          },
          plugins: {
            legend: {
              display: false // Legenda será controlada pela legenda compartilhada
            },
            tooltip: {
              enabled: false,
              external: (context) => {
                showCustomTooltip(context.chart, context.tooltip);
              }
            },
          },
          scales: {
            x: {
              ...commonXOptions,
              display: true
            },
            'y-left-primary': {
              type: 'linear',
              display: true,
              position: 'left',
              ticks: {
                color: "#164CAD",
                font: {
                  family: "Montserrat",
                  size: axisFontSize,
                  weight: "300",
                },
                callback: (v) => `${v.toFixed(0)}%`,
                stepSize: morpheusStep,
                min: morpheusYMin,
                max: morpheusYMax
              },
              grid: { 
                color: "rgba(0,0,0,0.05)",
                drawBorder: false
              },
              title: {
                display: true,
                text: 'Performance (%)',
                color: '#164CAD',
                font: {
                  family: "Montserrat",
                  size: 12,
                  weight: "500",
                }
              }
            },
            'y-left-secondary': {
              type: 'linear',
              display: true,
              position: 'right', // Usamos right inicialmente para depois mover para esquerda
              ticks: {
                color: "#4D7FDB",
                font: {
                  family: "Montserrat",
                  size: axisFontSize,
                  weight: "300",
                },
                callback: (v) => `${v.toFixed(1)}%`,
                stepSize: aoStep,
                min: aoYMin,
                max: aoYMax
              },
              grid: {
                drawOnChartArea: false, // Não desenhar grid para este eixo
              },
              title: {
                display: true,
                text: 'Dados AO (%)',
                color: '#4D7FDB',
                font: {
                  family: "Montserrat",
                  size: 12,
                  weight: "500",
                }
              },
              // Ajustar posição para simular segundo eixo à esquerda
              afterFit: function(scale) {
                // Mover o eixo para a esquerda (ajuste conforme necessário)
                scale.left = scale.left - 60;
                scale.right = scale.right - 60;
              }
            }
          },
          layout: {
            padding: {
              left: 5,
              right: 60, // Espaço extra à direita para o segundo eixo
              top: 10,
              bottom: 10
            }
          }
        },
      });

      // Criar legenda compartilhada com todos os datasets
      const allDatasets = [
        {
          label: "Morpheus",
          borderColor: "#164CAD"
        },
        {
          label: "Teoria",
          borderColor: "#000000"
        },
        {
          label: "Dados AO",
          borderColor: "#4D7FDB",
          backgroundColor: "rgba(77, 127, 219, 0.1)"
        }
      ];
      
      createSharedLegend(allDatasets);

      console.log("Gráfico único criado com sucesso com dois eixos Y na esquerda");
    }

    loadData();
  </script>

  <script>
    let orientationChangeTimeout;

    function detectarDispositivo() {
      const largura = window.innerWidth;
      const altura = window.innerHeight;
      const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
      
      const isMobileSize = largura <= 1024 || 
                          (largura < altura && largura <= 768) ||
                          (isTouchDevice && (largura <= 1024 || altura <= 1024));

      document.body.classList.remove('desktop-device', 'mobile-device', 'mobile-landscape');

      if (isMobileSize && isTouchDevice) {
        if (largura > altura) {
          document.body.classList.add('mobile-device', 'mobile-landscape');
        } else {
          document.body.classList.add('mobile-device');
        }
      } else {
        document.body.classList.add('desktop-device');
      }

      setTimeout(redesenharGraficoSuave, 100);
    }

    function redesenharGraficoSuave() {
      if (window.chartInstance) {
        setTimeout(() => {
          window.chartInstance.resize();
        }, 100);
      }
    }

    window.addEventListener('resize', function() {
      clearTimeout(orientationChangeTimeout);
      orientationChangeTimeout = setTimeout(detectarDispositivo, 250);
    });

    window.addEventListener('orientationchange', function() {
      clearTimeout(orientationChangeTimeout);
      orientationChangeTimeout = setTimeout(detectarDispositivo, 500);
    });
    
    setTimeout(detectarDispositivo, 100);
    detectarDispositivo();
  </script>
</body>
</html>

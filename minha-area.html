<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Clube Morpheus</title>
  <link rel="icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background-color: #fff;
      font-family: "DM Sans", sans-serif;
      color: #000;
      height: 100%;
    }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.9);
      padding: 10px 20px;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      z-index: 10;
      color: white;
      box-sizing: border-box;
    }

    .navbar .welcome {
      font-weight: bold;
      font-size: 16px;
    }

    .navbar .links {
      display: flex;
      gap: 20px;
    }

    .navbar a {
      color: white;
      text-decoration: none;
      font-weight: bold;
      font-size: 16px;
      transition: transform 0.2s ease-in-out;
    }

    .navbar a:hover {
      transform: scale(1.1);
    }

    /* ESTILOS PARA SMARTPHONE VERTICAL */
    .mobile-device .navbar {
      padding: 18px 20px;
      min-height: 75px;
    }

    .mobile-device .navbar .welcome {
      font-size: 24px;
      font-weight: bold;
    }

    .mobile-device .navbar .links {
      gap: 20px;
    }

    .mobile-device .navbar a {
      font-size: 24px;
      font-weight: bold;
    }

    /* ESTILOS PARA SMARTPHONE HORIZONTAL */
    .mobile-landscape .navbar {
      padding: 12px 20px;
    }

    .mobile-landscape .navbar .welcome {
      font-size: 18px;
    }

    .mobile-landscape .navbar .links {
      gap: 15px;
    }

    .mobile-landscape .navbar a {
      font-size: 18px;
    }

    /* ESTILOS PARA COMPUTADOR (DEFAULT) */
    .desktop-device .navbar {
      padding: 10px 20px;
    }

    .desktop-device .navbar .welcome {
      font-size: 16px;
    }

    .desktop-device .navbar .links {
      gap: 20px;
    }

    .desktop-device .navbar a {
      font-size: 16px;
    }

    @media (max-width: 768px) {
      .navbar {
        padding: 8px 15px;
      }

      .navbar .welcome {
        font-size: 14px;
      }

      .navbar .links {
        gap: 10px;
      }

      .navbar a {
        font-size: 14px;
      }
    }

    .container {
      margin-top: 60px;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 20px 0;
      min-height: calc(100vh - 80px);
    }

    /* AUMENTAR ESPAÇAMENTO NO CELULAR */
    .mobile-device .container {
      margin-top: 90px;
      padding-top: 30px;
    }

    .mobile-landscape .container {
      margin-top: 80px;
      padding-top: 25px;
    }

    .header-info {
      width: 95%;
      max-width: 1200px;
      text-align: left;
      margin-bottom: 20px;
      position: relative;
    }

    /* MAIOR ESPAÇAMENTO PARA NOME E DESCRIÇÃO NO MOBILE */
    .mobile-device .header-info {
      margin-bottom: 30px;
    }

    .mobile-landscape .header-info {
      margin-bottom: 25px;
    }

    .user-nome {
      font-size: 22px;
      color: #000000;
      margin: 0 0 2px 0;
      text-align: left;
      font-weight: bold;
    }

    .user-descricao {
      font-size: 16px;
      color: #555;
      margin: 0 0 30px 0;
      text-align: left;
      font-weight: 400;
    }

    /* AUMENTAR ESPAÇAMENTO ENTRE DESCRIÇÃO E PRÓXIMO CONTEÚDO NO MOBILE */
    .mobile-device .user-descricao {
      margin-bottom: 40px;
    }

    .mobile-landscape .user-descricao {
      margin-bottom: 35px;
    }

    .clube-nome {
      font-size: 22px;
      color: #1E4DB7;
      margin: 0 0 2px 0;
      text-align: left;
    }

    .cnpj {
      font-size: 13px;
      color: #555;
      margin: 0 0 2px 0;
      text-align: left;
    }

    .subtitle {
      font-size: 13px;
      color: #555;
      margin: 0;
      text-align: left;
    }

    /* ALTERADO: Container flex para alinhar horizontalmente nome/descrição com investimento */
    .header-top-container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      width: 100%;
      margin-bottom: 20px;
    }

    .header-user-info {
      flex: 1;
      text-align: left;
    }

    /* MODIFICADO: Container do investimento agora alinhado à direita */
    .investimento-disponivel-container {
      text-align: right;
      margin-left: 20px;
      flex-shrink: 0;
    }

    /* MODIFICADO: Estilo para o investimento item */
    .investimento-item {
      font-size: 18px;
      font-weight: bold;
      padding: 12px 16px;
      border-radius: 8px;
      color: #000000;
      text-align: right;
      white-space: nowrap;
    }

    /* NOVO: ESTILOS PARA AS DUAS LINHAS DO TEXTO */
    .investimento-item .linha1 {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 2px;
      text-align: right;
    }

    .investimento-item .linha2 {
      font-size: 18px;
      font-weight: bold;
      text-align: right;
    }

    .investimento-item .valor-disponivel {
      font-size: 18px;
      font-weight: bold;
    }

    /* ESTILOS RESPONSIVOS - MOBILE */
    @media (max-width: 768px) {
      .header-top-container {
        flex-direction: column;
      }
      
      .investimento-disponivel-container {
        margin-left: 0;
        margin-top: 20px;
        text-align: left;
        width: 100%;
      }
      
      .investimento-item {
        text-align: left;
        width: 100%;
        box-sizing: border-box;
        font-size: 16px;
        padding: 10px 14px;
        white-space: normal;
      }
      
      .investimento-item .linha1,
      .investimento-item .linha2,
      .investimento-item .valor-disponivel {
        font-size: 16px;
        text-align: left;
      }
    }

    .charts-main-container {
      width: 95%;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
      margin-bottom: 30px;
    }

    .main-chart-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    .chart-container {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 400px;
      background-color: #fff;
      border-radius: 8px;
      padding: 10px;
      box-sizing: border-box;
      position: relative;
      overflow: visible;
    }

    canvas {
      width: 100%;
      height: 380px !important;
      display: block;
      position: relative;
      z-index: 1;
    }

    .loading {
      color: #666;
      font-style: italic;
    }

    .error {
      color: #ff0000;
      background-color: #ffe6e6;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }

    /* ESTILOS DA TABELA DE APLICAÇÕES */
    .aplicacoes-container {
      width: 95%;
      max-width: 800px;
      margin: 30px auto;
      background-color: #fff;
      border-radius: 8px;
      padding: 20px;
    }

    .aplicacoes-container h2 {
      color: #1E4DB7;
      margin-bottom: 20px;
      text-align: center;
      font-family: "DM Sans", sans-serif;
    }

    .aplicacoes-table {
      width: 100%;
      border-collapse: collapse;
      font-family: "Montserrat", sans-serif;
    }

    .aplicacoes-table th {
      background-color: #164CAD;
      color: white;
      padding: 12px 15px;
      text-align: left;
      font-weight: bold;
      border: none;
    }

    .aplicacoes-table td {
      padding: 10px 15px;
      text-align: left;
      border: none;
      border-bottom: 1px solid #e0e0e0;
      color: #000000;
      font-weight: normal;
    }

    .aplicacoes-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .aplicacoes-table tr:hover {
      background-color: #f1f1f1;
    }

    .aplicacoes-table .total-row {
      background-color: #164CAD !important;
      color: white;
      font-weight: bold;
    }

    .aplicacoes-table .total-row td {
      border-bottom: none;
      background-color: #164CAD !important;
      color: white;
    }

    .no-aplicacoes {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 20px;
    }

    #deviceInfo {
      display: none !important;
    }

    /* ESTILOS DO TOOLTIP PERSONALIZADO */
    .custom-tooltip {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #164CAD;
      border-radius: 8px;
      padding: 12px 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      pointer-events: none;
      z-index: 100;
      font-family: "Montserrat", sans-serif;
      backdrop-filter: blur(5px);
      transition: opacity 0.2s ease;
      opacity: 0;
    }

    .custom-tooltip.visible {
      opacity: 1;
    }

    .custom-tooltip::before {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      border-style: solid;
    }

    .custom-tooltip.top::before {
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 8px 8px 0 8px;
      border-color: #164CAD transparent transparent transparent;
    }

    .custom-tooltip.bottom::before {
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 0 8px 8px 8px;
      border-color: transparent transparent #164CAD transparent;
    }

    .custom-tooltip.left::before {
      right: -8px;
      top: 50%;
      transform: translateY(-50%);
      border-width: 8px 0 8px 8px;
      border-color: transparent transparent transparent #164CAD;
    }

    .custom-tooltip.right::before {
      left: -8px;
      top: 50%;
      transform: translateY(-50%);
      border-width: 8px 8px 8px 0;
      border-color: transparent #164CAD transparent transparent;
    }

    .tooltip-header {
      font-weight: 550;
      color: #00000 ;
      margin-bottom: 8px;
      font-size: 14px;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 4px;
    }

    .tooltip-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .tooltip-item:last-child {
      margin-bottom: 0;
    }

    .tooltip-label {
      display: flex;
      align-items: center;
      color: #00000;
    }

    .tooltip-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      display: inline-block;
    }

    .tooltip-value {
      font-weight: 400;
      color: #00000;
      margin-left: 12px;
    }

    /* ESTILOS PARA AS LINHAS VERTICAIS DAS APLICAÇÕES - CORRIGIDAS */
    .vertical-line {
      position: absolute;
      width: 1px;
      background: repeating-linear-gradient(
        to bottom,
        transparent,
        transparent 3px,
        #000 3px,
        #000 6px
      );
      z-index: 2;
      pointer-events: none;
      transform: translateX(-0.5px);
    }

    .aplicacao-label {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #000;
      border-radius: 3px;
      padding: 4px 8px;
      font-size: 12px;
      font-family: "Montserrat", sans-serif;
      white-space: nowrap;
      z-index: 3;
      pointer-events: none;
      transform: translateY(0);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.2s ease;
      font-weight: 500;
      top: 35px;
    }

    .aplicacao-label:hover {
      background: rgba(255, 255, 255, 1);
      transform: scale(1.1);
      z-index: 10;
    }

    /* NOVO TOOLTIP PARA APLICAÇÕES NO GRÁFICO */
    .aplicacao-tooltip {
      position: absolute;
      background: rgba(255, 255, 255, 0.98);
      border: 2px solid #164CAD;
      border-radius: 8px;
      padding: 10px 14px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      pointer-events: none;
      z-index: 1000;
      font-family: "Montserrat", sans-serif;
      backdrop-filter: blur(10px);
      transition: opacity 0.2s ease;
      opacity: 0;
      min-width: 180px;
    }

    .aplicacao-tooltip.visible {
      opacity: 1;
    }

    .aplicacao-tooltip::before {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 8px 8px 0 8px;
      border-color: #164CAD transparent transparent transparent;
    }

    .tooltip-acao-numero {
      font-weight: bold;
      color: #164CAD;
      font-size: 14px;
      margin-bottom: 6px;
      text-align: center;
    }

    .tooltip-acao-detalhe {
      font-size: 12px;
      color: #333;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
    }

    .tooltip-acao-detalhe .label {
      font-weight: 500;
    }

    .tooltip-acao-detalhe .value {
      font-weight: 400;
    }

    /* Ajuste para mobile */
    .mobile-device .aplicacao-label {
      font-size: 14px;
      padding: 5px 10px;
      top: 45px;
    }

    .mobile-landscape .aplicacao-label {
      font-size: 11px;
      top: 30px;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="welcome" id="welcomeUser">Bem-vindo(a)</div>
    <div class="links">
      <a href="dashboard.html">Dashboard</a>
      <a href="lamina.html">Lâmina</a>
      <a href="minha-area.html">Minha Área</a>
    </div>
  </div>

  <div class="container">
    <div class="header-info">
      <!-- ALTERADO: Container flex para alinhar horizontalmente -->
      <div class="header-top-container">
        <div class="header-user-info">
          <div class="user-nome" id="userNome"></div>
          <div class="user-descricao" id="userDescricao"></div>
        </div>
        
        <!-- Container para "Você pode investir mais" - AGORA ALINHADO À DIREITA -->
        <div class="investimento-disponivel-container">
          <div class="investimento-item disponivel" id="investimentoDisponivel">
            <div class="linha1">Você pode investir</div>
            <div class="linha2">mais <span class="valor-disponivel">calculando...</span></div>
          </div>
        </div>
      </div>
      
      <h1 class="clube-nome">Morpheus Clube de Investimentos</h1>
      <div class="cnpj">61.043.820/0001-55</div>
      <div class="subtitle" id="subtitle">Carregando dados...</div>
    </div>
    
    <div class="charts-main-container">
      <div class="main-chart-container">
        <div class="chart-container">
          <canvas id="performanceChart"></canvas>
        </div>
      </div>
    </div>

    <div class="aplicacoes-container">
      <h2>Minhas Aplicações</h2>
      <div class="loading" id="aplicacoesLoading">Carregando aplicações...</div>
      <table class="aplicacoes-table" id="aplicacoesTable" style="display: none;">
        <thead>
          <tr>
            <th>Referência</th>
            <th>Data</th>
            <th>Valor Aplicado</th>
            <th>Valor Atual</th>
          </tr>
        </thead>
        <tbody id="aplicacoesTableBody">
        </tbody>
      </table>
      <div class="no-aplicacoes" id="noAplicacoes" style="display: none;">
        Nenhuma aplicação encontrada.
      </div>
    </div>

    <div id="deviceInfo"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAYLyEfTVl8zR1drcNYi7K33IT6ytVJYJ8",
      authDomain: "login-site-9cbbd.firebaseapp.com",
      projectId: "login-site-9cbbd",
      storageBucket: "login-site-9cbbd.appspot.com",
      messagingSenderId: "703993528666",
      appId: "1:703993528666:web:1e7a02cb5b611e24c97363",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userData = null;
    let cotasData = null;
    let ultimaCota = null;
    let patrimonio = 0;
    let dataCorteC3 = null;
    let aplicacoesProcessadas = [];
    let morpheusDataPoints = [];
    let chartDataPoints = [];
    let filteredDates = [];
    let morpheusVariacao = [];
    let totalAtualGlobal = 0;

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const docRef = doc(db, "usuarios", user.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          userData = docSnap.data();
          const nome = userData.nome || "Usuário";
          const genero = (userData.genero || "masculino").toLowerCase();
          const saudacao = genero === "feminino" ? "Bem-vinda" : "Bem-vindo";
          document.getElementById("welcomeUser").textContent = `${saudacao}, ${nome}`;
          
          document.getElementById("userNome").textContent = nome;
          document.getElementById("userDescricao").textContent = userData.descricao || "";
          
          await loadData();
        }
      } else {
        window.location.href = "index.html";
      }
    });

    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0orwAIfSmQxmbGdGCvjj3CZNbRnqo3Fr0ujodTX3JIcptCrR_ElNMZZn8tJ7MVg1W7Zeu5-KvLQLM/pub?gid=0&single=true&output=csv";

    window.chartInstances = {
      performanceChart: null
    };

    let customTooltip = null;
    let aplicacaoTooltip = null;

    function corrigirNumeroPlanilha(valorStr) {
      if (!valorStr || valorStr.trim() === '') return 0;
      
      let valor = valorStr.trim();
      valor = valor.replace(/"/g, '');
      
      if (!isNaN(parseFloat(valor)) && isFinite(valor)) {
        return parseFloat(valor);
      }
      
      if (valor.includes(',') && !valor.includes('.')) {
        valor = valor.replace(',', '.');
      }
      
      if (valor.includes('.') && valor.includes(',')) {
        valor = valor.replace(/\./g, '');
        valor = valor.replace(',', '.');
      }
      
      valor = valor.replace(/[^\d.-]/g, '');
      
      const resultado = parseFloat(valor);
      return isNaN(resultado) ? 0 : resultado;
    }

    async function buscarDadosPlanilha() {
      try {
        const response = await fetch(csvUrl);
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const data = await response.text();
        const rows = data.split("\n").filter(row => row.trim() !== '');
        
        console.log("Total de linhas na planilha:", rows.length);
        
        if (rows.length >= 3) {
          const linha3 = rows[2].split(",");
          console.log("Linha 3 (C3):", linha3);
          
          if (linha3.length >= 3) {
            dataCorteC3 = linha3[2].trim();
            console.log("Data de corte C3 encontrada:", dataCorteC3);
          }
        }
        
        if (rows.length >= 9) {
          const linha9 = rows[8].split(",");
          console.log("Linha 9 (D9/C9):", linha9);
          
          if (linha9.length >= 4) {
            patrimonio = corrigirNumeroPlanilha(linha9[3]);
            console.log("Patrimônio encontrado na linha 9, coluna D (índice 3):", patrimonio);
          }
          
          if (linha9.length >= 3) {
            ultimaCota = corrigirNumeroPlanilha(linha9[2]);
            console.log("Última cota encontrada na linha 9, coluna C (C9):", ultimaCota);
          }
        }
        
        return { patrimonio, ultimaCota, dataCorteC3 };
        
      } catch (error) {
        console.error("Erro ao buscar dados da planilha:", error);
        return { patrimonio: 0, ultimaCota: 0, dataCorteC3: null };
      }
    }

    function isDataPosteriorACorte(dataAplicacao) {
      if (!dataCorteC3 || !dataAplicacao) return false;
      
      try {
        const [diaCorte, mesCorte, anoCorte] = dataCorteC3.split('/');
        const [diaAplic, mesAplic, anoAplic] = dataAplicacao.split('/');
        
        const dataCorteObj = new Date(anoCorte, mesCorte - 1, diaCorte);
        const dataAplicObj = new Date(anoAplic, mesAplic - 1, diaAplic);
        
        return dataAplicObj > dataCorteObj;
      } catch (error) {
        console.error("Erro ao comparar datas:", error);
        return false;
      }
    }

    function calcularEExibirValorDisponivel() {
      console.log("Calculando valor disponível para investir:", {
        patrimonio: patrimonio,
        totalAtualGlobal: totalAtualGlobal,
        ultimaCota: ultimaCota
      });
      
      if (patrimonio === 0) {
        buscarDadosPlanilha().then(() => {
          if (patrimonio > 0) {
            calcularValorDisponivelEFinalizar();
          } else {
            exibirErroCalculo();
          }
        });
      } else {
        calcularValorDisponivelEFinalizar();
      }
    }

    function calcularValorDisponivelEFinalizar() {
      const investimentoDisponivel = ((0.4 * patrimonio) / 0.6) - (totalAtualGlobal / 0.6);
      
      console.log("Valor disponível calculado:", {
        patrimonio: patrimonio,
        totalAtualGlobal: totalAtualGlobal,
        investimentoDisponivel: investimentoDisponivel
      });
      
      const formatoMoeda = {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      };
      
      const disponivelFormatado = Math.max(0, investimentoDisponivel).toLocaleString('pt-BR', formatoMoeda);
      
      const elementoDisponivel = document.getElementById('investimentoDisponivel');
      
      if (elementoDisponivel) {
        elementoDisponivel.innerHTML = `
          <div class="linha1">Você pode investir</div>
          <div class="linha2">mais <span class="valor-disponivel">${disponivelFormatado}</span></div>
        `;
      }
    }

    function exibirErroCalculo() {
      const elementoDisponivel = document.getElementById('investimentoDisponivel');
      
      if (elementoDisponivel) {
        elementoDisponivel.innerHTML = `
          <div class="linha1">Você pode investir</div>
          <div class="linha2">mais <span class="valor-disponivel">Dados indisponíveis</span></div>
        `;
      }
    }

    function createCustomTooltip() {
      if (customTooltip) return customTooltip;
      
      customTooltip = document.createElement('div');
      customTooltip.className = 'custom-tooltip';
      document.querySelector('.main-chart-container').appendChild(customTooltip);
      return customTooltip;
    }

    function createAplicacaoTooltip() {
      if (aplicacaoTooltip) return aplicacaoTooltip;
      
      aplicacaoTooltip = document.createElement('div');
      aplicacaoTooltip.className = 'aplicacao-tooltip';
      document.querySelector('.main-chart-container').appendChild(aplicacaoTooltip);
      return aplicacaoTooltip;
    }

    function showCustomTooltip(chart, tooltip) {
      const tooltipEl = createCustomTooltip();
      
      if (tooltip.opacity === 0) {
        tooltipEl.classList.remove('visible');
        return;
      }

      if (tooltip.body) {
        const title = tooltip.title[0] || '';
        const bodyLines = tooltip.body.map(b => b.lines);
        
        let tooltipHTML = `<div class="tooltip-header">${title}</div>`;
        
        tooltip.dataPoints.forEach((dataPoint, index) => {
          const dataset = chart.data.datasets[dataPoint.datasetIndex];
          const rawValue = dataPoint.raw.y;
          const value = typeof rawValue === 'number' ? rawValue.toFixed(2).replace('.', ',') : '0,00';
          const label = dataset.label || '';
          const color = dataset.borderColor || '#164CAD';
          
          tooltipHTML += `
            <div class="tooltip-item">
              <span class="tooltip-label">
                <span class="tooltip-color" style="background-color: ${color}"></span>
                ${label}
              </span>
              <span class="tooltip-value">${value}</span>
            </div>
          `;
        });
        
        tooltipEl.innerHTML = tooltipHTML;
      }

      const position = chart.canvas.getBoundingClientRect();
      const chartContainer = document.querySelector('.main-chart-container');
      const containerRect = chartContainer.getBoundingClientRect();
      
      let left = position.left + tooltip.caretX - containerRect.left;
      let top = position.top + tooltip.caretY - containerRect.top;
      
      const tooltipWidth = tooltipEl.offsetWidth;
      const tooltipHeight = tooltipEl.offsetHeight;
      
      let placement = 'top';
      
      if (top - tooltipHeight - 10 < 0) {
        placement = 'bottom';
        top += 20;
      } else {
        top -= tooltipHeight + 10;
      }
      
      if (left + tooltipWidth > containerRect.width) {
        left = containerRect.width - tooltipWidth - 10;
      } else if (left < 0) {
        left = 10;
      } else {
        left -= tooltipWidth / 2;
      }
      
      tooltipEl.style.left = left + 'px';
      tooltipEl.style.top = top + 'px';
      tooltipEl.className = `custom-tooltip ${placement} visible`;
    }

    function showAplicacaoTooltip(aplicacao, numero, x, y) {
      const tooltipEl = createAplicacaoTooltip();
      
      const tipo = aplicacao.valorNumerico >= 0 ? 'Aplicação' : 'Resgate';
      const valorFormatado = aplicacao.valorNumerico.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      });
      
      tooltipEl.innerHTML = `
        <div class="tooltip-acao-numero">Ação ${numero}</div>
        <div class="tooltip-acao-detalhe">
          <span class="label">Tipo:</span>
          <span class="value">${tipo}</span>
        </div>
        <div class="tooltip-acao-detalhe">
          <span class="label">Data:</span>
          <span class="value">${aplicacao.data}</span>
        </div>
        <div class="tooltip-acao-detalhe">
          <span class="label">Valor:</span>
          <span class="value">${valorFormatado}</span>
        </div>
      `;
      
      const chartContainer = document.querySelector('.main-chart-container');
      const containerRect = chartContainer.getBoundingClientRect();
      
      let left = x - containerRect.left;
      let top = y - containerRect.top - tooltipEl.offsetHeight - 15;
      
      if (top < 10) {
        top = y - containerRect.top + 25;
        tooltipEl.style.setProperty('--arrow-position', 'top');
      } else {
        tooltipEl.style.setProperty('--arrow-position', 'bottom');
      }
      
      if (left + tooltipEl.offsetWidth > containerRect.width - 10) {
        left = containerRect.width - tooltipEl.offsetWidth - 10;
      }
      
      if (left < 10) {
        left = 10;
      }
      
      tooltipEl.style.left = left + 'px';
      tooltipEl.style.top = top + 'px';
      tooltipEl.classList.add('visible');
    }

    function hideAplicacaoTooltip() {
      if (aplicacaoTooltip) {
        aplicacaoTooltip.classList.remove('visible');
      }
    }

    function adicionarLinhasAplicacoesNoGrafico(aplicacoes, chart) {
      if (!aplicacoes || aplicacoes.length === 0 || !chart) return;
      
      const chartContainer = document.querySelector('.chart-container');
      const chartArea = chart.chartArea;
      
      const existingLines = chartContainer.querySelectorAll('.vertical-line, .aplicacao-label');
      existingLines.forEach(el => el.remove());
      
      const morpheusData = chart.data.datasets[0].data;
      
      aplicacoes.forEach((aplicacao, index) => {
        const dataAplicacao = aplicacao.data;
        const valor = aplicacao.valorNumerico;
        const valorStr = aplicacao.valorStr;
        
        const [dia, mes, ano] = dataAplicacao.split('/');
        const dataAplicacaoObj = new Date(ano, mes - 1, dia);
        
        let pontoEncontrado = null;
        let menorDiferenca = Infinity;
        
        morpheusData.forEach((ponto) => {
          if (ponto && ponto.x) {
            const dataPonto = new Date(ponto.x);
            const diferenca = Math.abs(dataPonto - dataAplicacaoObj);
            
            if (diferenca < menorDiferenca) {
              menorDiferenca = diferenca;
              pontoEncontrado = ponto;
            }
          }
        });
        
        if (!pontoEncontrado) return;
        
        const xScale = chart.scales.x;
        const yScale = chart.scales.y;
        
        const dataPontoTimestamp = new Date(pontoEncontrado.x).getTime();
        
        const pixelXCanvas = xScale.getPixelForValue(dataPontoTimestamp);
        const pixelYCanvas = yScale.getPixelForValue(pontoEncontrado.y);
        
        const canvasRect = chart.canvas.getBoundingClientRect();
        const containerRect = chartContainer.getBoundingClientRect();
        
        const posXAbsoluta = canvasRect.left + pixelXCanvas;
        const posXRelativa = posXAbsoluta - containerRect.left;
        const posYTopo = 35;
        
        const posYAbsoluta = canvasRect.top + pixelYCanvas;
        const posYRelativaPonto = posYAbsoluta - containerRect.top;
        const alturaLinha = Math.max(0, posYRelativaPonto - posYTopo);
        
        if (posXRelativa >= 0 && posXRelativa <= containerRect.width) {
          const line = document.createElement('div');
          line.className = 'vertical-line';
          line.style.left = posXRelativa + 'px';
          line.style.top = posYTopo + 'px';
          line.style.height = alturaLinha + 'px';
          chartContainer.appendChild(line);
          
          const label = document.createElement('div');
          label.className = 'aplicacao-label';
          label.style.left = (posXRelativa + 5) + 'px';
          label.textContent = (index + 1).toString();
          label.setAttribute('data-index', index);
          label.setAttribute('data-aplicacao', JSON.stringify(aplicacao));
          
          label.addEventListener('mouseenter', (e) => {
            const rect = e.target.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top;
            showAplicacaoTooltip(aplicacao, index + 1, x, y);
          });
          
          label.addEventListener('mouseleave', hideAplicacaoTooltip);
          
          chartContainer.appendChild(label);
        }
      });
    }

    function encontrarCotaPorData(dataAplicacao) {
      if (!cotasData || cotasData.length === 0) return null;
      
      const [dia, mes, ano] = dataAplicacao.split('/');
      const dataAplicacaoObj = new Date(ano, mes - 1, dia);
      
      let cotaEncontrada = null;
      let menorDiferenca = Infinity;
      
      for (let i = 0; i < cotasData.length; i++) {
        const cotaData = cotasData[i];
        const [cotaDia, cotaMes, cotaAno] = cotaData.data.split('/');
        const dataCotaObj = new Date(cotaAno, cotaMes - 1, cotaDia);
        
        const diferenca = dataAplicacaoObj - dataCotaObj;
        
        if (diferenca >= 0 && diferenca < menorDiferenca) {
          menorDiferenca = diferenca;
          cotaEncontrada = cotaData;
        }
      }
      
      if (!cotaEncontrada && cotasData.length > 0) {
        cotaEncontrada = cotasData[0];
      }
      
      return cotaEncontrada;
    }

    function calcularValorAtual(valorAplicado, cotaAplicacao, dataAplicacao) {
      if (isDataPosteriorACorte(dataAplicacao)) {
        console.log(`Aplicação em ${dataAplicacao} é posterior à data de corte ${dataCorteC3}. Valor atual = valor aplicado.`);
        return valorAplicado;
      }
      
      if (!cotaAplicacao || !ultimaCota || ultimaCota === 0) {
        console.log("Dados insuficientes para cálculo:", {
          cotaAplicacao: cotaAplicacao,
          ultimaCota: ultimaCota,
          valorAplicado: valorAplicado
        });
        return null;
      }
      
      try {
        const quantidadeCotas = valorAplicado / cotaAplicacao.cota;
        const valorAtual = quantidadeCotas * ultimaCota;
        const valorAtualArredondado = Math.round(valorAtual * 100) / 100;
        
        console.log("Cálculo do valor atual (usando C9):", {
          valorAplicado: valorAplicado,
          cotaAplicacao: cotaAplicacao.cota,
          ultimaCota: ultimaCota,
          quantidadeCotas: quantidadeCotas,
          valorAtual: valorAtualArredondado
        });
        
        return valorAtualArredondado;
      } catch (error) {
        console.error("Erro no cálculo do valor atual:", error);
        return null;
      }
    }

    function formatarValorComEspaco(valorStr) {
      if (valorStr.includes('R$') && !valorStr.includes('R$ ')) {
        return valorStr.replace('R$', 'R$ ');
      }
      return valorStr;
    }

    function processarAplicacoesString(aplicacoesString) {
      if (!aplicacoesString || aplicacoesString.trim() === '') return [];
      
      let aplicacoesProcessada = aplicacoesString.trim();
      
      if (aplicacoesProcessada.startsWith('"')) {
        aplicacoesProcessada = aplicacoesProcessada.substring(1);
      }
      
      if (aplicacoesProcessada.endsWith('"')) {
        aplicacoesProcessada = aplicacoesProcessada.substring(0, aplicacoesProcessada.length - 1);
      }
      
      aplicacoesProcessada = aplicacoesProcessada.trim();

      const aplicacoes = aplicacoesProcessada.split(';').filter(ap => ap.trim() !== '');
      
      const aplicacoesProcessadas = [];
      
      aplicacoes.forEach((aplicacao, index) => {
        const dataRegex = /(\d{2}\/\d{2}\/\d{4})/;
        const match = aplicacao.match(dataRegex);
        
        if (!match) return;
        
        const data = match[1];
        const restante = aplicacao.substring(data.length).trim();
        
        let valorStr = restante;
        let valorNumerico;
        
        if (valorStr.startsWith('-')) {
          const valorPositivoStr = valorStr.substring(1).replace('R$', '').trim();
          valorNumerico = -corrigirNumeroPlanilha(valorPositivoStr);
          valorStr = `-R$ ${Math.abs(valorNumerico).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        } else {
          const valorPositivoStr = valorStr.replace('R$', '').trim();
          valorNumerico = corrigirNumeroPlanilha(valorPositivoStr);
          valorStr = `R$ ${Math.abs(valorNumerico).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }
        
        if (!isNaN(valorNumerico)) {
          aplicacoesProcessadas.push({
            data: data,
            valorStr: valorStr,
            valorNumerico: valorNumerico
          });
        }
      });
      
      return aplicacoesProcessadas;
    }

    function carregarAplicacoes(aplicacoesString) {
      const loadingElement = document.getElementById('aplicacoesLoading');
      const tableElement = document.getElementById('aplicacoesTable');
      const tableBody = document.getElementById('aplicacoesTableBody');
      const noAplicacoesElement = document.getElementById('noAplicacoes');

      loadingElement.style.display = 'none';

      aplicacoesProcessadas = processarAplicacoesString(aplicacoesString);
      
      if (aplicacoesProcessadas.length === 0) {
        noAplicacoesElement.style.display = 'block';
        setTimeout(calcularEExibirValorDisponivel, 100);
        return;
      }

      let totalAplicado = 0;
      let totalAtual = 0;
      let temDadosValidos = false;

      tableBody.innerHTML = '';

      buscarDadosPlanilha().then(() => {
        console.log("Dados para cálculo:", {
          ultimaCota: ultimaCota,
          dataCorteC3: dataCorteC3,
          patrimonio: patrimonio
        });
        
        aplicacoesProcessadas.forEach((aplicacao, index) => {
          const data = aplicacao.data;
          const valorStr = aplicacao.valorStr;
          const valorNumerico = aplicacao.valorNumerico;
          
          if (!isNaN(valorNumerico)) {
            totalAplicado += valorNumerico;
            temDadosValidos = true;
          }

          const cotaAplicacao = encontrarCotaPorData(data);
          let valorAtual = null;
          let valorAtualFormatado = 'N/A';

          console.log("Processando aplicação:", {
            index: index,
            data: data,
            valor: valorNumerico,
            cotaAplicacao: cotaAplicacao,
            ultimaCota: ultimaCota,
            dataCorteC3: dataCorteC3,
            isPosterior: isDataPosteriorACorte(data)
          });

          if (cotaAplicacao && valorNumerico) {
            valorAtual = calcularValorAtual(valorNumerico, cotaAplicacao, data);
            if (valorAtual !== null) {
              totalAtual += valorAtual;
              valorAtualFormatado = `R$ ${valorAtual.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
          }

          const row = document.createElement('tr');
          
          const numeroCell = document.createElement('td');
          numeroCell.textContent = (index + 1).toString();
          
          const dataCell = document.createElement('td');
          dataCell.textContent = data;
          
          const valorCell = document.createElement('td');
          valorCell.textContent = valorStr;
          
          const valorAtualCell = document.createElement('td');
          valorAtualCell.textContent = valorAtualFormatado;
          
          row.appendChild(numeroCell);
          row.appendChild(dataCell);
          row.appendChild(valorCell);
          row.appendChild(valorAtualCell);
          
          tableBody.appendChild(row);
        });

        if (temDadosValidos) {
          const totalRow = document.createElement('tr');
          totalRow.className = 'total-row';
          
          const totalLabelCell = document.createElement('td');
          totalLabelCell.textContent = 'Total';
          totalLabelCell.style.fontWeight = 'bold';
          
          const totalVazioCell = document.createElement('td');
          totalVazioCell.textContent = '';
          
          const totalAplicadoCell = document.createElement('td');
          totalAplicadoCell.textContent = `R$ ${totalAplicado.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
          totalAplicadoCell.style.fontWeight = 'bold';
          
          const totalAtualCell = document.createElement('td');
          const totalAtualFinal = totalAtual > 0 ? totalAtual : 0;
          totalAtualCell.textContent = `R$ ${totalAtualFinal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
          totalAtualCell.style.fontWeight = 'bold';
          
          totalRow.appendChild(totalLabelCell);
          totalRow.appendChild(totalVazioCell);
          totalRow.appendChild(totalAplicadoCell);
          totalRow.appendChild(totalAtualCell);
          
          tableBody.appendChild(totalRow);
          
          totalAtualGlobal = totalAtualFinal;
        }

        tableElement.style.display = 'table';
        
        calcularEExibirValorDisponivel();
      });
    }

    async function loadData() {
      try {
        console.log("Iniciando carregamento de dados...");
        
        const response = await fetch(csvUrl);
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const data = await response.text();
        const rows = data.split("\n").filter(row => row.trim() !== '');

        console.log("Total de linhas no CSV:", rows.length);
        
        await buscarDadosPlanilha();

        if (rows.length < 2) {
          throw new Error("Dados insuficientes no CSV");
        }

        const allDates = [];
        const morpheusValores = [];
        const ibovValores = [];
        cotasData = [];

        for (let i = 1; i < rows.length; i++) {
          const cols = rows[i].split(",");
          if (cols.length >= 12) {
            const date = cols[9]?.trim();
            const cotaMorpheus = corrigirNumeroPlanilha(cols[10]);
            const valorIbov = corrigirNumeroPlanilha(cols[11]);
            
            if (date && !isNaN(cotaMorpheus) && !isNaN(valorIbov)) {
              allDates.push(date);
              morpheusValores.push(cotaMorpheus);
              ibovValores.push(valorIbov);
              
              cotasData.push({
                data: date,
                cota: cotaMorpheus
              });
            }
          }
        }

        let ibovVariacao = [];

        if (userData && userData.aplicacoes) {
          aplicacoesProcessadas = processarAplicacoesString(userData.aplicacoes);
        }

        let indexInicio = 0;
        if (aplicacoesProcessadas.length > 0) {
          const primeiraDataAplicacao = aplicacoesProcessadas[0].data;
          const [dia, mes, ano] = primeiraDataAplicacao.split('/');
          const primeiraDataObj = new Date(ano, mes - 1, dia);
          
          for (let i = 0; i < allDates.length; i++) {
            const [cotaDia, cotaMes, cotaAno] = allDates[i].split('/');
            const dataCotaObj = new Date(cotaAno, cotaMes - 1, cotaDia);
            
            if (dataCotaObj >= primeiraDataObj) {
              indexInicio = i;
              break;
            }
          }
        }

        const morpheusBase = morpheusValores[indexInicio];
        const ibovBase = ibovValores[indexInicio];

        for (let i = indexInicio; i < allDates.length; i++) {
          const variacaoMorpheus = ((morpheusValores[i] / morpheusBase) - 1) * 100;
          const variacaoIbov = ((ibovValores[i] / ibovBase) - 1) * 100;
          
          morpheusVariacao.push(variacaoMorpheus);
          ibovVariacao.push(variacaoIbov);
          filteredDates.push(allDates[i]);
        }

        if (filteredDates.length === 0) {
          const morpheusBase = morpheusValores[0];
          const ibovBase = ibovValores[0];
          
          for (let i = 0; i < allDates.length; i++) {
            const variacaoMorpheus = ((morpheusValores[i] / morpheusBase) - 1) * 100;
            const variacaoIbov = ((ibovValores[i] / ibovBase) - 1) * 100;
            
            morpheusVariacao.push(variacaoMorpheus);
            ibovVariacao.push(variacaoIbov);
            filteredDates.push(allDates[i]);
          }
        }

        if (filteredDates.length === 0) {
          throw new Error("Nenhum dado válido encontrado para o gráfico");
        }

        const lastDate = filteredDates[filteredDates.length - 1];
        document.getElementById("subtitle").textContent = lastDate;

        createMainChart(filteredDates, morpheusVariacao, ibovVariacao);

        if (userData && userData.aplicacoes) {
          carregarAplicacoes(userData.aplicacoes);
        } else {
          buscarDadosPlanilha().then(() => {
            calcularEExibirValorDisponivel();
          });
        }

      } catch (error) {
        console.error("Erro ao carregar dados:", error);
        document.getElementById("subtitle").textContent = "Erro ao carregar dados";
      }
    }

    function createMainChart(allDates, morpheus, ibov) {
      const morpheusData = allDates.map((date, i) => ({
        x: date.split("/").reverse().join("-"),
        y: morpheus[i]
      }));

      const ibovData = allDates.map((date, i) => ({
        x: date.split("/").reverse().join("-"),
        y: ibov[i]
      }));

      chartDataPoints = morpheusData;

      const canvas = document.getElementById("performanceChart");
      const ctx = canvas.getContext("2d");

      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);

      const isMobileVertical = document.body.classList.contains('mobile-device') && 
                          !document.body.classList.contains('mobile-landscape');
      
      const axisFontSize = isMobileVertical ? 22 : 15;
      const legendFontSize = isMobileVertical ? 20 : 12;

      const createGradient = (ctx, chartArea) => {
        const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
        gradient.addColorStop(0, "#F6F8FC");
        gradient.addColorStop(0.5, "#8EA8D7");
        gradient.addColorStop(1, "#164CAD");
        return gradient;
      };

      const chart = new Chart(ctx, {
        type: "line",
        data: {
          datasets: [
            {
              label: "Morpheus",
              data: morpheusData,
              borderColor: "#164CAD",
              borderWidth: 1.5,
              pointRadius: 0,
              tension: 0.15,
              fill: true,
              backgroundColor: function(context) {
                const chart = context.chart;
                const {ctx, chartArea} = chart;
                if (!chartArea) {
                  return null;
                }
                return createGradient(ctx, chartArea);
              },
              order: 2,
            },
            {
              label: "IBOV",
              data: ibovData,
              borderColor: "#000000",
              borderWidth: 1.5,
              pointRadius: 0,
              tension: 0.15,
              fill: false,
              order: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index',
          },
          plugins: {
            legend: {
              position: "top",
              labels: {
                usePointStyle: true,
                pointStyle: "circle",
                color: "#000000",
                font: {
                  family: "Montserrat",
                  size: legendFontSize,
                  weight: "300",
                },
              },
              reverse: true
            },
            tooltip: {
              enabled: false,
              external: (context) => {
                showCustomTooltip(context.chart, context.tooltip);
              }
            },
          },
          scales: {
            x: {
              type: "time",
              time: {
                unit: "month",
                displayFormats: { 
                  month: "MMM - yy" 
                },
                tooltipFormat: "dd/MM/yyyy"
              },
              ticks: {
                color: "#000000",
                maxRotation: 45,
                minRotation: 45,
                font: {
                  family: "Montserrat",
                  size: axisFontSize,
                  weight: "300",
                },
                callback: function(value, index, values) {
                  const date = new Date(value);
                  const month = date.getMonth();
                  const year = date.getFullYear().toString().slice(-2);
                  
                  const mesesPortugues = [
                    'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                    'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'
                  ];
                  
                  return `${mesesPortugues[month]} - ${year}`;
                }
              },
              grid: { color: "rgba(0,0,0,0.05)" },
            },
            y: {
              ticks: {
                color: "#000000",
                font: {
                  family: "Montserrat",
                  size: axisFontSize,
                  weight: "300",
                },
                callback: (v) => `${v.toFixed(0)}%`,
                stepSize: 5
              },
              grid: { color: "rgba(0,0,0,0.05)" },
            },
          },
          animation: {
            onComplete: function() {
              if (aplicacoesProcessadas.length > 0) {
                console.log("Gráfico renderizado - Adicionando linhas");
                setTimeout(() => {
                  adicionarLinhasAplicacoesNoGrafico(aplicacoesProcessadas, chart);
                }, 100);
              }
            }
          }
        },
      });

      window.chartInstances.performanceChart = chart;
    }
  </script>

  <script>
    let orientationChangeTimeout;

    function detectarDispositivo() {
      const largura = window.innerWidth;
      const altura = window.innerHeight;
      const deviceInfo = document.getElementById('deviceInfo');
      const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
      
      const isMobileSize = largura <= 1024 || 
                          (largura < altura && largura <= 768) ||
                          (isTouchDevice && (largura <= 1024 || altura <= 1024));

      const wasMobileLandscape = document.body.classList.contains('mobile-landscape');
      const isNowMobileLandscape = isMobileSize && isTouchDevice && largura > altura;

      document.body.classList.remove('desktop-device', 'mobile-device', 'mobile-landscape');

      if (isMobileSize && isTouchDevice) {
        if (largura > altura) {
          document.body.classList.add('mobile-device', 'mobile-landscape');
        } else {
          document.body.classList.add('mobile-device');
        }
      } else {
        document.body.classList.add('desktop-device');
      }
      
      if (window.chartInstances.performanceChart) {
        setTimeout(() => {
          window.chartInstances.performanceChart.resize();
          if (aplicacoesProcessadas && aplicacoesProcessadas.length > 0) {
            adicionarLinhasAplicacoesNoGrafico(aplicacoesProcessadas, window.chartInstances.performanceChart);
          }
        }, 100);
      }
    }

    window.addEventListener('resize', function() {
      clearTimeout(orientationChangeTimeout);
      orientationChangeTimeout = setTimeout(detectarDispositivo, 250);
    });

    window.addEventListener('orientationchange', function() {
      clearTimeout(orientationChangeTimeout);
      orientationChangeTimeout = setTimeout(detectarDispositivo, 500);
    });
    
    setTimeout(detectarDispositivo, 100);
    detectarDispositivo();
  </script>
</body>
</html>

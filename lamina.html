<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Morpheus</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "DM Sans", sans-serif;
      background-color: #fff;
      color: #1e1e1e;
    }
    header {
      background: #0b1e52;
      color: #fff;
      text-align: center;
      padding: 16px 0;
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 1px;
    }
    main {
      max-width: 1000px;
      margin: 40px auto;
      text-align: center;
    }
    canvas {
      width: 100%;
      height: 420px;
    }
    .subtitle {
      color: #555;
      font-size: 14px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <header>MORPHEUS</header>
  <main>
    <div class="subtitle">Comparativo com IBOV</div>
    <canvas id="grafico"></canvas>
    <div id="erro" style="color:#777; margin-top:8px;"></div>
  </main>

  <script>
    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0orwAIfSmQxmbGdGCvjj3CZNbRnqo3Fr0ujodTX3JIcptCrR_ElNMZZn8tJ7MVg1W7Zeu5-KvLQLM/pub?gid=0&single=true&output=csv";

    async function carregarDados() {
      try {
        const resp = await fetch(url);
        const texto = await resp.text();
        const linhas = texto.trim().split("\n").slice(1);

        const datas = [];
        const morpheus = [];
        const ibov = [];
        let ultimaData = "";

        linhas.forEach(l => {
          const cols = l.split(",");
          const data = cols[9]; // Coluna J
          const morpheusVal = parseFloat(cols[10].replace(",", "."));
          const ibovVal = parseFloat(cols[11].replace(",", "."));
          if (data && !isNaN(morpheusVal) && !isNaN(ibovVal)) {
            datas.push(data);
            morpheus.push((morpheusVal - 1) * 100);
            ibov.push((ibovVal - 1) * 100);
            ultimaData = data; // Atualiza a última data válida
          }
        });

        const ctx = document.getElementById("grafico").getContext("2d");
        const gradiente = ctx.createLinearGradient(0, 0, 0, 400);
        gradiente.addColorStop(0, "rgba(0, 60, 255, 0.6)");
        gradiente.addColorStop(1, "rgba(0, 60, 255, 0.0)");

        // Conjunto para rastrear meses exibidos
        const mesesExibidos = new Set();

        new Chart(ctx, {
          type: "line",
          data: {
            labels: datas,
            datasets: [
              {
                label: "Morpheus",
                data: morpheus,
                borderColor: "#003CFF",
                borderWidth: 1.8,
                backgroundColor: gradiente,
                fill: true,
                pointRadius: 0,
                tension: 0.25,
              },
              {
                label: "IBOV",
                data: ibov,
                borderColor: "#000000",
                borderWidth: 1.5,
                fill: false,
                pointRadius: 0,
                tension: 0.25,
              }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: "index", intersect: false },
            plugins: {
              legend: {
                position: "top",
                labels: { usePointStyle: true, pointStyle: "circle" }
              },
              tooltip: {
                callbacks: {
                  label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`
                }
              }
            },
            scales: {
              x: {
                ticks: {
                  callback: (val, i) => {
                    const data = new Date(datas[i]);
                    // Garante que a data seja válida e a partir de 01/07/2025
                    if (data >= new Date("2025-07-01")) {
                      const mes = data.toLocaleString("pt-BR", { month: "short" });
                      const ano = data.getFullYear().toString().slice(-2);
                      const chaveMes = `${mes}-${ano}`;
                      if (!mesesExibidos.has(chaveMes)) {
                        mesesExibidos.add(chaveMes);
                        return `${mes} - ${ano}`;
                      }
                      return "";
                    }
                    return "";
                  },
                  maxRotation: 45,
                  minRotation: 45
                },
                grid: { color: "rgba(0,0,0,0.08)" }
              },
              y: {
                ticks: {
                  callback: val => `${val.toFixed(0)}%`
                },
                grid: { color: "rgba(0,0,0,0.08)" }
              }
            }
          }
        });

        // Atualiza o subtítulo com a última data
        document.querySelector(".subtitle").textContent = `Comparativo com IBOV - até ${ultimaData}`;
      } catch (err) {
        document.getElementById("erro").textContent = "Erro ao carregar dados — Comparativo com IBOV";
        console.error(err);
      }
    }

    carregarDados();
  </script>
</body>
</html>
